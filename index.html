<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Audio Rating Task – MWE</title>

  <!-- jsPsych core & plugins -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7/dist/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@7"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.2.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@1.2.0"></script>

  <style>
    body { max-width: 820px; margin: 40px auto; padding: 0 20px; }
  </style>
</head>
<body>
  <!-- jsPsych가 여기에 렌더링합니다 -->
  <div id="jspsych-target"></div>

  <script>
    /* ===== UI TEXTS ===== */
    const TEXTS = {
      welcomeTitle: 'Audio Rating Task',
      welcomeBody: 'You will hear short sounds and rate them on a scale.',
      startBtn: 'Start',
      prompt: 'How strongly did this sound match the “sarcastic” category?',
      leftLabel: 'Not at all',
      rightLabel: 'Very strongly',
      endTitle: 'Thanks!',
      endBody: 'Your data have been prepared.',
      finishBtn: 'Finish'
    };

    /* ===== STIMULI (파일 경로는 HTML 기준) ===== */
    const STIMULI = [
      { file: 'audio/amazed.wav' },
      { file: 'audio/sarcastic.wav' }
    ];

    /* ===== SLIDER ===== */
    const SLIDER = {
      min: 1, max: 7, step: 1, start: 4, require_movement: true,
      labels: ['1','2','3','4','5','6','7']
    };

    /* ===== INIT ===== */
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: () => {
        // 여기서는 업로드 생략 (UI 확인용 최소본)
        const csv = jsPsych.data.get().csv();
        console.log('CSV preview:\n', csv);
      }
    });

    /* ===== PRELOAD (오류 로깅 켜기) ===== */
    const preload = {
      type: jsPsychPreload,
      audio: STIMULI.map(s => s.file),
      continue_after_error: false,
      on_error: (file) => console.error('Preload failed:', file)
    };

    /* ===== WELCOME / END ===== */
    const welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>${TEXTS.welcomeTitle}</h2><p>${TEXTS.welcomeBody}</p>`,
      choices: [TEXTS.startBtn]
    };

    const end = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>${TEXTS.endTitle}</h2><p>${TEXTS.endBody}</p>`,
      choices: [TEXTS.finishBtn]
    };

    /* ===== TRIAL: timelineVariable을 trial 내부에서 직접 사용 ===== */
    const audioRatingTrial = {
      type: jsPsychAudioSliderResponse,
      stimulus: jsPsych.timelineVariable('file'),
      prompt:
        `<p>${TEXTS.prompt}</p>
         <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-top:4px;">
           <span>${TEXTS.leftLabel}</span><span>${TEXTS.rightLabel}</span>
         </div>`,
      slider_min: SLIDER.min,
      slider_max: SLIDER.max,
      slider_start: SLIDER.start,
      slider_step: SLIDER.step,
      labels: SLIDER.labels,
      require_movement: SLIDER.require_movement,
      response_allowed_while_playing: false,
      trial_ends_after_audio: false,
      on_load: () => console.log('Loaded trial for:', jsPsych.timelineVariable('file')()),
      data: { task: 'rating', stimulus_file: jsPsych.timelineVariable('file') },
      on_finish: (d) => {
        d.rating     = d.response;
        d.stimulus   = d.stimulus_file || d.stimulus;
        d.user_agent = navigator.userAgent;
        d.timestamp  = new Date().toISOString();
      }
    };

    const rating_block = {
      timeline: [ audioRatingTrial ],
      timeline_variables: STIMULI,
      sample: { type: 'without-replacement' }
    };

    /* ===== RUN (로드 완료 후) ===== */
    window.addEventListener('load', () => {
      jsPsych.run([preload, welcome, rating_block, end]);
    });
  </script>
</body>
</html>
